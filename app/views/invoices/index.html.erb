<div class="page-header">
  <div>
    <h1 class="page-title">üßæ Facturaci√≥n</h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem;">Administra las ventas y documentos fiscales</p>
  </div>
  <div class="page-actions">
    <%= link_to "Nueva Factura", new_invoice_path, class: "btn btn-primary" %>
  </div>
</div>

<% if @invoices.any? %>
  <% 
    total_ventas = @invoices.sum(&:total)
    total_impuestos = @invoices.sum(&:tax_total)
    facturas_finalizadas = @invoices.count(&:finalized?)
    facturas_borrador = @invoices.count(&:draft?)
  %>
  
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value"><%= @invoices.count %></div>
      <div class="stat-label">Facturas Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value currency">‚Ç°<%= number_with_delimiter(total_ventas, delimiter: ",") %></div>
      <div class="stat-label">Ventas Totales</div>
    </div>
    <div class="stat-card">
      <div class="stat-value currency">‚Ç°<%= number_with_delimiter(total_impuestos, delimiter: ",") %></div>
      <div class="stat-label">Impuestos Recaudados</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="color: var(--success);"><%= facturas_finalizadas %></div>
      <div class="stat-label">Facturas Finalizadas</div>
    </div>
  </div>

  <div class="card fade-in">
    <div class="card-header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title">Registro de Facturas</h3>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <span class="badge badge-warning">üìù <%= facturas_borrador %> Borradores</span>
          <span class="badge badge-success">‚úÖ <%= facturas_finalizadas %> Finalizadas</span>
        </div>
      </div>
    </div>
    <div class="card-body" style="padding: 0;">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Factura</th>
              <th>Cliente</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <% @invoices.each do |invoice| %>
              <tr style="<%= 'background: rgba(16, 185, 129, 0.05);' if invoice.finalized? %>">
                <td>
                  <div style="font-weight: 700; color: var(--text-primary); font-family: 'Courier New', monospace;">
                    #<%= invoice.invoice_number %>
                  </div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">
                    <%= pluralize(invoice.total_items_count, 'producto') %>
                  </div>
                </td>
                <td>
                  <div style="font-weight: 600; color: var(--text-primary);"><%= invoice.client_name %></div>
                  <% if invoice.client_email.present? %>
                    <div style="font-size: 0.8rem; color: var(--text-muted);"><%= invoice.client_email %></div>
                  <% end %>
                </td>
                <td>
                  <div style="color: var(--text-secondary);">
                    <%= invoice.created_at ? Date.parse(invoice.created_at).strftime('%d/%m/%Y') : 'N/A' %>
                  </div>
                </td>
                <td>
                  <span class="badge badge-<%= invoice.finalized? ? 'success' : 'warning' %>">
                    <%= invoice.finalized? ? '‚úÖ Finalizada' : 'üìù Borrador' %>
                  </span>
                </td>
                <td>
                  <div style="text-align: right;">
                    <div class="currency" style="font-size: 1.1rem; font-weight: 700;">
                      ‚Ç°<%= number_with_delimiter(invoice.total, delimiter: ",") %>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">
                      +‚Ç°<%= number_with_delimiter(invoice.tax_total, delimiter: ",") %> impuestos
                    </div>
                  </div>
                </td>
                <td>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <%= link_to "üëÅ", invoice_path(invoice), class: "btn btn-sm btn-secondary", title: "Ver factura" %>
                    
                    <% if invoice.can_be_edited? %>
                      <%= link_to "‚úèÔ∏è", edit_invoice_path(invoice), class: "btn btn-sm btn-secondary", title: "Editar" %>
                    <% else %>
                      <span class="btn btn-sm disabled" title="No editable">‚úèÔ∏è</span>
                    <% end %>
                    
                    <% if invoice.items.any? %>
                      <%= link_to "üìÑ", download_pdf_invoice_path(invoice), class: "btn btn-sm btn-success", title: "Descargar PDF" %>
                    <% end %>
                    
                    <% if invoice.can_be_edited? %>
                      <%= button_to "üóë", invoice_path(invoice), 
                                   method: :delete,
                                   class: "btn btn-sm btn-danger",
                                   title: "Eliminar",
                                   form: { onsubmit: "return confirm('¬øEliminar factura ##{invoice.invoice_number}?')" } %>
                    <% else %>
                      <span class="btn btn-sm disabled" title="No se puede eliminar">üóë</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="card">
    <div class="card-body">
      <div class="empty-state">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üßæ</div>
        <h3>Sin facturas registradas</h3>
        <p>Comienza creando tu primera factura para gestionar ventas</p>
        <%= link_to "Crear Primera Factura", new_invoice_path, class: "btn btn-primary", style: "margin-top: 1rem;" %>
      </div>
    </div>
  </div>
<% end %>