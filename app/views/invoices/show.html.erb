<div class="page-header">
  <div>
    <h1 class="page-title">
      üßæ Factura #<%= @invoice.invoice_number %>
      <span class="badge badge-<%= @invoice.finalized? ? 'success' : 'warning' %>" style="margin-left: 1rem;">
        <%= @invoice.finalized? ? '‚úÖ Finalizada' : 'üìù Borrador' %>
      </span>
    </h1>
    <p style="color: var(--text-muted); margin-top: 0.5rem;">
      Cliente: <%= @invoice.client_name %> ‚Ä¢ 
      <%= @invoice.created_at ? Date.parse(@invoice.created_at).strftime('%d/%m/%Y') : 'Sin fecha' %>
    </p>
  </div>
  <div class="page-actions">
    <% if @invoice.items.any? %>
      <%= link_to "üìÑ Descargar PDF", download_pdf_invoice_path(@invoice), class: "btn btn-success" %>
    <% end %>
    <% if @invoice.can_be_edited? %>
      <%= link_to "‚úèÔ∏è Editar", edit_invoice_path(@invoice), class: "btn btn-primary" %>
    <% else %>
      <span class="btn disabled" title="No se puede editar una factura finalizada">‚úèÔ∏è Editar</span>
    <% end %>
    <%= link_to "‚Ü©Ô∏è Volver", invoices_path, class: "btn btn-secondary" %>
  </div>
</div>

<% if @invoice.finalized? %>
  <div class="alert alert-success" style="margin-bottom: 2rem;">
    <strong>‚úÖ Factura Finalizada</strong><br>
    Esta factura est√° bloqueada y el stock ha sido descontado autom√°ticamente.
  </div>
<% end %>

<div class="stats-grid" style="margin-bottom: 2rem;">
  <div class="stat-card">
    <div class="stat-value"><%= @invoice.total_items_count %></div>
    <div class="stat-label">Productos</div>
  </div>
  <div class="stat-card">
    <div class="stat-value currency">‚Ç°<%= number_with_delimiter(@invoice.subtotal, delimiter: ",") %></div>
    <div class="stat-label">Subtotal</div>
  </div>
  <div class="stat-card">
    <div class="stat-value currency">‚Ç°<%= number_with_delimiter(@invoice.tax_total, delimiter: ",") %></div>
    <div class="stat-label">Impuestos</div>
  </div>
  <div class="stat-card">
    <div class="stat-value currency" style="font-size: 2.5rem;">‚Ç°<%= number_with_delimiter(@invoice.total, delimiter: ",") %></div>
    <div class="stat-label">Total Final</div>
  </div>
</div>

<div class="grid grid-cols-2">
  <div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">üë§ Informaci√≥n del Cliente</h3>
      </div>
      <div class="card-body">
        <div style="display: grid; gap: 1rem;">
          <div>
            <strong style="color: var(--text-primary);">Cliente:</strong>
            <div style="color: var(--text-secondary); margin-top: 0.25rem;"><%= @invoice.client_name %></div>
          </div>
          
          <div>
            <strong style="color: var(--text-primary);">Email:</strong>
            <div style="color: var(--text-secondary); margin-top: 0.25rem;">
              <%= @invoice.client_email.present? ? @invoice.client_email : 'No especificado' %>
            </div>
          </div>
          
          <div>
            <strong style="color: var(--text-primary);">Fecha de Emisi√≥n:</strong>
            <div style="color: var(--text-secondary); margin-top: 0.25rem;">
              <%= @invoice.created_at ? Date.parse(@invoice.created_at).strftime('%d de %B de %Y') : 'N/A' %>
            </div>
          </div>
          
          <div>
            <strong style="color: var(--text-primary);">Estado:</strong>
            <div style="margin-top: 0.25rem;">
              <span class="badge badge-<%= @invoice.finalized? ? 'success' : 'warning' %>">
                <%= @invoice.finalized? ? '‚úÖ Finalizada' : 'üìù Borrador' %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <% if @invoice.can_be_finalized? %>
      <div class="card" style="border-color: var(--success);">
        <div class="card-header" style="background: rgba(16, 185, 129, 0.1);">
          <h3 class="card-title" style="color: var(--success);">üéØ Finalizar Factura</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: 1rem; color: var(--text-secondary);">
            Al finalizar la factura se descontar√° autom√°ticamente el stock de los productos. 
            <strong>Esta acci√≥n no se puede deshacer.</strong>
          </p>
          <%= button_to "‚úÖ Finalizar Factura", finalize_invoice_path(@invoice), 
                       method: :post, 
                       class: "btn btn-success",
                       style: "width: 100%;",
                       form: { onsubmit: "return confirm('¬øConfirmas finalizar la factura ##{@invoice.invoice_number}? El stock se descontar√° autom√°ticamente.')" } %>
        </div>
      </div>
    <% elsif @invoice.finalized? %>
      <div class="card" style="border-color: var(--success);">
        <div class="card-body" style="text-align: center; background: rgba(16, 185, 129, 0.05);">
          <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚úÖ</div>
          <h4 style="color: var(--success); margin-bottom: 0.5rem;">Factura Procesada</h4>
          <p style="color: var(--text-secondary); margin: 0;">Stock descontado autom√°ticamente</p>
        </div>
      </div>
    <% end %>
  </div>
  
  <div>
    <% if @invoice.items.any? %>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìä Desglose de Impuestos</h3>
        </div>
        <div class="card-body">
          <div style="display: grid; gap: 1rem;">
            <% @invoice.tax_summary.each do |tax_info| %>
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem;">
                <div>
                  <div style="font-weight: 600; color: var(--text-primary);"><%= tax_info[:name] %></div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);"><%= tax_info[:percentage] %>% sobre ‚Ç°<%= number_with_delimiter(tax_info[:base_amount], delimiter: ",") %></div>
                </div>
                <div style="text-align: right;">
                  <div class="currency" style="font-weight: 700;">‚Ç°<%= number_with_delimiter(tax_info[:tax_amount], delimiter: ",") %></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<% if @invoice.items.any? %>
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">üõí Detalle de Productos</h3>
    </div>
    <div class="card-body" style="padding: 0;">
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unit.</th>
              <th>Subtotal</th>
              <th>Impuesto</th>
              <th>Total L√≠nea</th>
            </tr>
          </thead>
          <tbody>
            <% @invoice.items.each do |item| %>
              <% 
                line_subtotal = item['quantity'].to_i * item['unit_price'].to_f
                line_tax = line_subtotal * item['tax_percentage'].to_f / 100
                line_total = line_subtotal + line_tax
              %>
              <tr>
                <td>
                  <div style="font-weight: 600; color: var(--text-primary);"><%= item['product_name'] %></div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">ID: <%= item['product_id'] %></div>
                </td>
                <td style="font-weight: 600; font-size: 1.1rem;"><%= item['quantity'] %></td>
                <td>
                  <span class="currency">‚Ç°<%= number_with_delimiter(item['unit_price'].to_f, delimiter: ",") %></span>
                </td>
                <td>
                  <span class="currency">‚Ç°<%= number_with_delimiter(line_subtotal, delimiter: ",") %></span>
                </td>
                <td>
                  <div style="font-weight: 600; color: var(--text-primary);"><%= item['tax_rate_name'] %></div>
                  <div style="font-size: 0.8rem; color: var(--text-muted);">
                    <%= item['tax_percentage'] %>% = ‚Ç°<%= number_with_delimiter(line_tax, delimiter: ",") %>
                  </div>
                </td>
                <td>
                  <span class="currency" style="font-weight: 700; font-size: 1.1rem;">
                    ‚Ç°<%= number_with_delimiter(line_total, delimiter: ",") %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot>
            <tr style="background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); font-weight: 700;">
              <td colspan="2"><strong>TOTALES</strong></td>
              <td>-</td>
              <td><span class="currency">‚Ç°<%= number_with_delimiter(@invoice.subtotal, delimiter: ",") %></span></td>
              <td><span class="currency">‚Ç°<%= number_with_delimiter(@invoice.tax_total, delimiter: ",") %></span></td>
              <td><span class="currency" style="font-size: 1.2rem;">‚Ç°<%= number_with_delimiter(@invoice.total, delimiter: ",") %></span></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="card">
    <div class="card-body">
      <div class="empty-state">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
        <h3>Factura Vac√≠a</h3>
        <p>Esta factura no tiene productos asociados</p>
        <% if @invoice.can_be_edited? %>
          <%= link_to "Agregar Productos", edit_invoice_path(@invoice), class: "btn btn-primary", style: "margin-top: 1rem;" %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>